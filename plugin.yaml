tosca_definitions_version: cloudify_dsl_1_2

plugins:
  mist:
    executor: central_deployment_agent
    source: "https://github.com/mistio/cloudify-mist-plugin/archive/master.zip"

data_types:
  cloudify.datatypes.mist.Config:
    properties:
      mist_username:
          description: >
            A mist.io username
          type: string
          default: ''
      mist_password:
          description: >
            A mist.io password
          type: string
          default: ''
      mist_token:
          description: >
            A mist.io authentication token
          type: string
          default: ''
      mist_uri:
          description: >
            The mist.io URL
          type: string
          default: https://mist.io
  cloudify.datatypes.mist.MachineParams:
    properties:
      cloud_id:
          description: >
            The cloud id where the machine will be created
          type: string
          default: ''
      name:
          description: >
            The name for the machine created
          type: string
          default: ''
      key:
          description: >
            An ssh to connect to the machine created
          type: string
          default: ''
      image_id:
          description: >
            The id of the image for this machine
          type: string
          default: ''
      size_id:
          description: >
            The size of the machine
          type: string
          default: ''
      location_id:
          descsription: >
            The id for the location of this machine
          type: string
          default: ''
      location_name:
          descsription: >
            The name of the location of this machine
          type: string
          default: ''
      image_extra:
          description: >
            Image specific extra details
          type: string
          default: ''
      disk:
          description: >
            The disk that this machine will have
          type: string
          default: ''
      script:
          description: >
            Provide an inline script to run against the machine
          type: string
          default: ''
      monitoring:
          description: >
            Enable monitoring on this machine
          type: boolean
          default: false
      ips:
          description: >
            A list of IPs to assign to this machine
          default: []
      networks:
          description: >
            A list of networks that this machine belongs to
          default: []
      docker_command:
          desciption: >
            Run a docker command 
          type: string
          default: ''
      script_id:
          description: >
            The id of the script to run against this machine
          type: string
          default: ''
      script_params:
          description: >
            The params for the script 
          type: string
          default: ''
      provider:
          description: >
            The provider where this machine will be created
          type: string
          default: ''
      # This is only used in OpenStack clouds
      associate_floating_ip:
          type: boolean
          default: true
      tags:
          description: A set of tags to assign to this machine
          default: {}


node_types:
  cloudify.mist.nodes.KeyPair:
    derived_from: cloudify.nodes.Root
    properties:
      install_agent:
        description: >
          Indicates whether or not to install a Cloudify Agent on this host.
        type: boolean
        default: false
      use_external_resource:
        description: >
          Indicate whether the resource exists or if Cloudify should create the resource.
        type: boolean
        default: false
      resource_id:
        description: >
          Either the name or ID of the resource in Cloudify. If this is an existing
          resource, you should provide the name or the ID of the resource in Amazon AWS.
        type: string
        default: ''
      private_key_path:
        description: >
          The path where the key should be saved on the machine. If this is a bootstrap
          process, this refers to the local computer. If this will run on the manager,
          this will be saved on the manager.
        type: string
        default: ''
      parameters:
        description: >
          The key value pair parameters required by Mist Client to use
          the mist.client.backend.create_machine command.(backend_id,image_id
          size_id, location_id, name, monitoring, ssh_user, networks)
        default: {}
      mist_config:
        description: >
          A dictionary of values to pass to authenticate with the Mist API.
        type: cloudify.datatypes.mist.Config
    interfaces:
      cloudify.interfaces.lifecycle:
        create: mist.plugin.keypair.create
        delete: mist.plugin.keypair.delete
      cloudify.interfaces.validation:
        creation: mist.plugin.keypair.creation_validation

  cloudify.mist.nodes.Server:
    derived_from: cloudify.nodes.Compute
    properties:
      install_agent:
        description: >
          Indicates whether or not to install a Cloudify Agent on this host.
        type: boolean
        default: false
      use_external_resource:
        description: >
          Indicate whether the resource exists or if Cloudify should create the resource.
        type: boolean
        default: false
      resource_id:
        description: >
          Either the name or ID of the resource in Cloudify. If this is an existing
          resource, you should provide the name or the ID of the resource in Mist.io.
        type: string
        default: ''
      parameters:
        description: >
          The key value pair parameters required by Mist Client to use
          the mist.client.backend.create_machine command.(backend_id,image_id
          size_id, location_id, name, monitoring, ssh_user, networks )
        type: cloudify.datatypes.mist.MachineParams
      mist_config:
        description: >
          A dictionary of values to pass to authenticate with the Mist API.
        type: cloudify.datatypes.mist.Config
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: mist.plugin.server.create
          inputs:
            use_external_resource:
              description: >
                Indicate whether the resource exists or if Cloudify should create the resource.
              type: boolean
              default: false
            mist_config:
              description: >
                A dictionary of values to pass to authenticate with the Mist API.
              default: {}
        start:
          implementation: mist.plugin.server.start
          inputs:
            start_retry_interval:
              description: Polling interval until the server is active in seconds
              type: integer
              default: 30
        stop:
          implementation: mist.plugin.server.stop
          inputs:
            mist_config:
              description: >
                A dictionary of values to pass to authenticate with the Mist API.
              default: {}
        delete:
          implementation: mist.plugin.server.delete
          inputs:
            mist_config:
              description: >
                A dictionary of values to pass to authenticate with the Mist API.
              default: {}
      cloudify.interfaces.validation:
        creation:
          implementation: mist.plugin.server.creation_validation
          inputs:
            args:
              default: {}

  cloudify.mist.nodes.Network:
    derived_from: cloudify.nodes.Network
    properties:
      install_agent:
        description: >
          Indicates whether or not to install a Cloudify Agent on this host.
        type: boolean
        default: false
      use_external_resource:
        description: >
          Indicate whether the resource exists or if Cloudify should create the resource.
        type: boolean
        default: false
      resource_id:
        description: >
          Either the name or ID of the resource in Cloudify. If this is an existing
          resource, you should provide the name or the ID of the resource in Mist.io.
        type: string
        default: ''
      parameters:
        description: >
          The key value pair parameters required by Mist Client to use
          the mist.client.cloud.create_network command.(
          {"network":{"name":"testnet","admin_state_up":true},
          "subnet":{"name":"happy_subnet","ip_version":"4","cidr":"",
          "gateway_ip":"","enable_dhcp":true,
          "allocation_pools":[{"start":"","end":""}]}}: )
        default: {}
      mist_config:
        description: >
          A dictionary of values to pass to authenticate with the Mist API.
        default: {}
    interfaces:
      cloudify.interfaces.lifecycle:
        create:
          implementation: mist.plugin.network.create
        delete:
          implementation: mist.plugin.network.delete


relationships:
  cloudify.mist.relationships.server_connected_to_keypair:
    derived_from: cloudify.relationships.connected_to
  # TODO: This needs to be implemented
  cloudify.mist.relationships.server_connected_to_network:
    derived_from: cloudify.relationships.depends_on
    target_interfaces:
      cloudify.interfaces.relationship_lifecycle:
        preconfigure:
          implementation: mist.plugin.network.associate_network
          inputs:
            ip:
              description: The IP to associate to this node
              type: string
              default: ''
            assign:
              description: Indicate whether to associate this node to an IP
              type: boolean
              default: true
